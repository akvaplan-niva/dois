#!/bin/bash
mkdir -p crossref slim
rm -rf crossref/* slim/*

# Extract DOIs from raw publication references
cat raw/*.txt | ./bin/raw2doi | ./bin/crossref-works  \
  | nd-map d.DOI | sort | uniq > doi/misc/raw.ndjson

# Get Crossref "works" metadata for each DOI
cat doi/*/*.ndjson | sort | uniq | ./bin/crossref-works 2> crossref/err.txt \
  | nd-group d.DOI | nd-map 'd[1][0]' \
  > crossref/akvaplan-works.ndjson

# Create slim metadata, partitioned by year
cat crossref/akvaplan-works.ndjson | ./bin/crossref-slim \
  | ./bin/partition-slim-by-year

# Show summary counts
./bin/slim-counts

# Verify SHA checksums
./bin/verify-checksums
